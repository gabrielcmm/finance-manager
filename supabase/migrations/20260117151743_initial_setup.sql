-- ==========================================
-- 1. TIPOS E ENUMS
-- ==========================================
-- Define se Ã© entrada ou saÃ­da de dinheiro
create type public.transaction_type as enum ('income', 'expense');

-- ==========================================
-- 2. TABELAS
-- ==========================================

-- Tabela: Contas (Carteira, Banco, etc.)
create table public.accounts (
  id bigint generated by default as identity primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  user_id uuid references auth.users not null,
  name text not null,
  initial_balance numeric(12, 2) default 0.00, -- Suporta valores atÃ© 999 mil milhÃµes
  is_default boolean default false
);

-- Tabela: Categorias
create table public.categories (
  id bigint generated by default as identity primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  user_id uuid references auth.users not null,
  name text not null,
  icon text,
  type public.transaction_type not null default 'expense',
  is_editable boolean default true
);

-- Tabela: TransaÃ§Ãµes (O coraÃ§Ã£o do sistema)
create table public.transactions (
  id bigint generated by default as identity primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  user_id uuid references auth.users not null,
  account_id bigint references public.accounts(id) on delete cascade not null,
  category_id bigint references public.categories(id) on delete set null, -- Se apagar a categoria, a transaÃ§Ã£o fica "Sem categoria"
  amount numeric(12, 2) not null,
  date date not null default CURRENT_DATE,
  description text,
  type public.transaction_type not null
);

-- ==========================================
-- 3. SEGURANÃ‡A (Row Level Security)
-- ==========================================

-- Ativar RLS em todas as tabelas
alter table public.accounts enable row level security;
alter table public.categories enable row level security;
alter table public.transactions enable row level security;

-- PolÃ­tica GenÃ©rica: O utilizador vÃª e edita APENAS o que Ã© seu.
-- (Repetimos a lÃ³gica para manter o cÃ³digo limpo e seguro)

-- Accounts
create policy "Users manage their own accounts" on public.accounts for all
using ( auth.uid() = user_id ) with check ( auth.uid() = user_id );

-- Categories
create policy "Users manage their own categories" on public.categories for all
using ( auth.uid() = user_id ) with check ( auth.uid() = user_id );

-- Transactions
create policy "Users manage their own transactions" on public.transactions for all
using ( auth.uid() = user_id ) with check ( auth.uid() = user_id );

-- ==========================================
-- 4. PERFORMANCE (Ãndices)
-- ==========================================
-- Ãndices aceleram as queries quando tiveres milhares de transaÃ§Ãµes
create index idx_transactions_user_date on public.transactions(user_id, date);
create index idx_transactions_account on public.transactions(account_id);
create index idx_categories_user on public.categories(user_id);

-- ==========================================
-- 5. AUTOMATIZAÃ‡ÃƒO E I18N (O Trigger)
-- ==========================================

create or replace function public.handle_new_user()
returns trigger
language plpgsql
security definer
as $$
declare
  user_lang text;
  -- DefiniÃ§Ã£o dos dados padrÃ£o (Categorias E Contas)
  default_data jsonb := '{
    "pt-BR": {
      "categories": [
        {"name": "AlimentaÃ§Ã£o", "icon": "ğŸ”", "type": "expense"},
        {"name": "Transporte", "icon": "ğŸšŒ", "type": "expense"},
        {"name": "Moradia", "icon": "ğŸ ", "type": "expense"},
        {"name": "SalÃ¡rio", "icon": "ğŸ’°", "type": "income"}
      ],
      "accounts": [
        {"name": "Carteira (Dinheiro)", "is_default": true},
        {"name": "Conta BancÃ¡ria", "is_default": false}
      ]
    },
    "en": {
      "categories": [
        {"name": "Food", "icon": "ğŸ”", "type": "expense"},
        {"name": "Transport", "icon": "ğŸšŒ", "type": "expense"},
        {"name": "Housing", "icon": "ğŸ ", "type": "expense"},
        {"name": "Salary", "icon": "ğŸ’°", "type": "income"}
      ],
      "accounts": [
        {"name": "Cash / Wallet", "is_default": true},
        {"name": "Bank Account", "is_default": false}
      ]
    }
  }';
  
  -- VariÃ¡veis auxiliares
  selected_data jsonb;
  item jsonb;
begin
  -- 1. Detetar lÃ­ngua
  user_lang := coalesce(new.raw_user_meta_data->>'language', 'en');
  
  -- 2. Selecionar dados (Fallback para EN se nÃ£o encontrar)
  selected_data := default_data->user_lang;
  IF selected_data IS NULL THEN
    selected_data := default_data->'en';
  END IF;

  -- 3. Criar Contas PadrÃ£o
  for item in SELECT * FROM jsonb_array_elements(selected_data->'accounts')
  loop
    insert into public.accounts (user_id, name, is_default)
    values (new.id, item->>'name', (item->>'is_default')::boolean);
  end loop;

  -- 4. Criar Categorias PadrÃ£o
  for item in SELECT * FROM jsonb_array_elements(selected_data->'categories')
  loop
    insert into public.categories (user_id, name, icon, type)
    values (new.id, item->>'name', item->>'icon', (item->>'type')::public.transaction_type);
  end loop;

  return new;
end;
$$;

-- Ligar o gatilho
create trigger on_auth_user_created
  after insert on auth.users
  for each row execute procedure public.handle_new_user();